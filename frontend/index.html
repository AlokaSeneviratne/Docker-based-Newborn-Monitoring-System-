<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Newborn Monitor Dashboard</title>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      font-family: sans-serif;
      background: #0d1117;
      color: #eee;
      text-align: center;
      padding-bottom: 40px;
    }

    h1 { margin-top: 20px; }

    .card {
      border-radius: 12px;
      padding: 15px;
      width: 280px;
      margin: 15px auto;
      color: #fff;
      font-weight: bold;
    }

    .value { font-size: 32px; margin: 10px 0; }
    .status { font-size: 14px; opacity: 0.8; }

    /* Card colours */
    .hr     { background: #c62828; }
    .spo2   { background: #1565c0; }
    .temp   { background: #ef6c00; }
    .motion { background: #2e7d32; }

    /* Chart container styling */
    .chart-container {
      width: 90%;
      max-width: 600px;
      margin: 25px auto;
      background: #111;
      padding: 15px;
      border-radius: 12px;
    }
  </style>
</head>

<body>

  <h1>Newborn Monitor – Live</h1>
  <div id="status">Loading...</div>

  <!-- Cards -->
  <div class="card hr">
    <div>Heart Rate</div>
    <div class="value" id="hr">--</div>
    <div class="status" id="hrValid"></div>
  </div>

  <div class="card spo2">
    <div>SpO₂</div>
    <div class="value" id="spo2">--</div>
    <div class="status" id="spo2Valid"></div>
  </div>

  <div class="card temp">
    <div>Temperature</div>
    <div class="value" id="temp">--</div>
    <div class="status" id="tempStatus"></div>
  </div>

  <div class="card motion">
    <div>Motion</div>
    <div class="value" id="motion">--</div>
    <div class="status" id="motionStatus"></div>
  </div>


  <!-- Graphs -->
  <div class="chart-container">
    <canvas id="hrChart"></canvas>
  </div>

  <div class="chart-container">
    <canvas id="spo2Chart"></canvas>
  </div>

  <div class="chart-container">
    <canvas id="tempChart"></canvas>
  </div>

  <div class="chart-container">
    <canvas id="motionChart"></canvas>
  </div>


  <script>
    const API_BASE = "https://sds-final-project-psenevir.rahtiapp.fi";

    
    // Chart.js Setup
    // ----------------------
    function createChart(canvasId, label, color) {
      return new Chart(document.getElementById(canvasId), {
        type: "line",
        data: {
          labels: [],
          datasets: [{
            label: label,
            data: [],
            borderColor: color,
            borderWidth: 2,
            fill: false,
            tension: 0.2
          }]
        },
        options: {
          responsive: true,
          animation: false,
          scales: {
            x: { title: { display: false } },
            y: { beginAtZero: false }
          }
        }
      });
    }

    
    const hrChart     = createChart("hrChart",     "Heart Rate",   "#ff5252");
    const spo2Chart   = createChart("spo2Chart",   "SpO₂",          "#42a5f5");
    const tempChart   = createChart("tempChart",   "Temperature",   "#ff9800");
    const motionChart = createChart("motionChart", "Motion",        "#66bb6a");

    
    function addData(chart, value) {
      const now = new Date().toLocaleTimeString();
      chart.data.labels.push(now);
      chart.data.datasets[0].data.push(value);

      if (chart.data.labels.length > 60) {
        chart.data.labels.shift();
        chart.data.datasets[0].data.shift();
      }

      chart.update();
    }

    
    // Fetch API Data
    // ----------------------
    async function fetchLatest() {
      const statusEl = document.getElementById("status");

      try {
        const res = await fetch(`${API_BASE}/api/latest`);
        if (!res.ok) {
          statusEl.textContent = "Backend error: " + res.status;
          return;
        }

        const data = await res.json();
        statusEl.textContent = "Last update: " + data.ts;

        
        document.getElementById("hr").textContent = data.hr;
        document.getElementById("hrValid").textContent = data.hrValid ? "Valid" : "Invalid";

        document.getElementById("spo2").textContent = data.spo2;
        document.getElementById("spo2Valid").textContent = data.spo2Valid ? "Valid" : "Invalid";

        document.getElementById("temp").textContent = data.temp.toFixed(1) + " °C";
        document.getElementById("tempStatus").textContent = data.tempStatus;

        document.getElementById("motion").textContent = data.motion.toFixed(3);
        document.getElementById("motionStatus").textContent = data.motionStatus;

        
        addData(hrChart, data.hr);
        addData(spo2Chart, data.spo2);
        addData(tempChart, data.temp);
        addData(motionChart, data.motion);

      } catch (err) {
        console.error(err);
        statusEl.textContent = "Error fetching data";
      }
    }

    // Poll every 2 seconds
    fetchLatest();
    setInterval(fetchLatest, 2000);
  </script>

</body>
</html>
